name: Build all Rust apps

on:
    workflow_call:
      inputs:
        c_sdk_branch:
          required: false
          default: ''
          type: string
        rust_sdk_branch:
          required: false
          default: ''
          type: string
    workflow_dispatch:
      inputs:
        c_sdk_branch:
          required: false
          default: ''
          type: string
        rust_sdk_branch:
          required: false
          default: ''
          type: string

env:
  C_SDK_URL: 'https://github.com/LedgerHQ/ledger-secure-sdk.git'

jobs:      
    retrieve-rust-apps:
      name: Retrieve Rust Apps
      runs-on: ubuntu-latest
      outputs:
        rust_apps: ${{ steps.get_rust_apps.outputs.rust_apps }}
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            repository: LedgerHQ/ledger-device-rust-sdk
            ref: 'master'
        - name: Set up Python
          uses: actions/setup-python@v4
          with:
              python-version: '3.x'
        - name: Install ledgered
          run: pip install ledgered
        - name: Get all rust apps
          id: get_rust_apps
          run: |
            python .github/workflows/get_rust_apps.py ${{ secrets.GITHUB_TOKEN }}
            echo "rust_apps=$(cat rust_apps.json)" >> $GITHUB_OUTPUT

    display-rust-apps:
      name: Display Rust Apps
      runs-on: ubuntu-latest
      needs: retrieve-rust-apps
      steps:
        - name: Display Rust Apps
          run: |
            echo "Rust apps: ${{ needs.retrieve-rust-apps.outputs.rust_apps }}"

    test-build:
        name: Build for all targets
        needs: [retrieve-rust-apps]
        strategy:
            fail-fast: false
            matrix:
              app-name: ["app-boilerplate-rust"]
              device: ["nanos+", "nanox", "stax", "flex"]
              include: ${{ fromJSON(needs.retrieve-rust-apps.outputs.rust_apps) }}
        runs-on: ubuntu-latest
        container:
            image: ghcr.io/ledgerhq/ledger-app-builder/ledger-app-builder:latest
        steps:
            - name: Install ledgered
              run: pip install ledgered --break-system-packages
            - name: Clone SDK
              if: ${{ inputs.rust_sdk_branch != '' }}
              uses: actions/checkout@v4
              with:
                path: sdk
                repository: LedgerHQ/ledger-device-rust-sdk
                ref: ${{ inputs.rust_sdk_branch }}
            - name: Clone App
              uses: actions/checkout@v4
              with:
                repository: LedgerHQ/${{ matrix.app-name }}
                submodules: true
                path: ${{ matrix.app-name }}
            - name: Patch Cargo.toml
              continue-on-error: false
              if: ${{ inputs.rust_sdk_branch != '' }}
              run: |
                cd ${{ matrix.app-name }}
                build_directory=$(ledger-manifest --output-build-directory ledger_app.toml)
                cd $build_directory
                # Required as patch has a different version from what is locked in Cargo.lock
                cargo update include_gif
                cargo update ledger_secure_sdk_sys
                cargo update ledger_device_sdk

                workspace_root=$(cargo metadata --no-deps --format-version 1 | jq -r '.workspace_root')
                cargo_toml_path="$workspace_root/Cargo.toml"
                
                # Patch ledger_device_sdk
                echo "" >> $cargo_toml_path
                echo "[patch.crates-io.ledger_device_sdk]" >> $cargo_toml_path
                path=\"$GITHUB_WORKSPACE/sdk/ledger_device_sdk\"
                echo "path=$path" >> $cargo_toml_path
                echo "Patch added to Cargo.toml"
                
                # Patch ledger_secure_sdk_sys
                echo "" >> $cargo_toml_path
                echo "[patch.crates-io.ledger_secure_sdk_sys]" >> $cargo_toml_path
                path=\"$GITHUB_WORKSPACE/sdk/ledger_secure_sdk_sys\"
                echo "path=$path" >> $cargo_toml_path
                echo "Patch added to Cargo.toml"
                
                # Patch include_gif
                echo "" >> $cargo_toml_path
                echo "[patch.crates-io.include_gif]" >> $cargo_toml_path
                path=\"$GITHUB_WORKSPACE/sdk/include_gif\"
                echo "path=$path" >> $cargo_toml_path
                echo "Patch added to Cargo.toml"

                # Print Cargo.toml
                echo "Cargo.toml:"
                cat $cargo_toml_path

            - name: Build
              run: |
                # Clone C SDK if provided
                if [ -n "${{ inputs.c_sdk_branch }}" ]; then
                    git clone $C_SDK_URL --branch ${{ inputs.c_sdk_branch }} --single-branch c_sdk
                    echo "setting LEDGER_SDK_PATH to $(realpath c_sdk)"
                    export LEDGER_SDK_PATH=$(realpath c_sdk)

                    test_api_level=$(grep "API_LEVEL :=" "$LEDGER_SDK_PATH/Makefile.defines")
                    echo "test_api_level=$test_api_level"
                    if [ "${{ matrix.device }}" = "nanos+" ]; then
                        path="/opt/nanosplus-secure-sdk"
                    elif [ "${{ matrix.device }}" = "nanox" ]; then
                        path="/opt/nanox-secure-sdk"
                    elif [ "${{ matrix.device }}" = "stax" ]; then
                        path="/opt/stax-secure-sdk"
                    elif [ "${{ matrix.device }}" = "flex" ]; then
                        path="/opt/flex-secure-sdk"
                    elif [ "${{ matrix.device }}" = "apex_p" ]; then
                        path="/opt/apex-secure-sdk"
                    else  
                        echo "unknown device"
                        exit 1
                    fi
                    current_api_level=$(grep "API_LEVEL :=" "$path/Makefile.defines")
                    echo "current_api_level=$current_api_level"
                    if [ "$test_api_level" != "$current_api_level" ]; then
                        echo "Do not build for ${{ matrix.device }} as the API level of the provided C SDK ($test_api_level) does not match the expected one ($current_api_level)"
                        exit 0
                    fi
                else
                    echo "using C SDK from ledger-app-builder"
                fi
                cd ${{ matrix.app-name }}
                build_directory=$(ledger-manifest --output-build-directory ledger_app.toml)
                cd $build_directory
                cargo update include_gif
                cargo update ledger_secure_sdk_sys
                cargo update ledger_device_sdk
                echo "Building app for ${{ matrix.device }}"
                device=$(echo ${{ matrix.device }} | sed 's/+/plus/')
                echo "Build for "$device
                cargo ledger build $device
                # Get the binary path and set it as an output variable
                BINARY_PATH=$(cargo metadata --no-deps --format-version 1 | jq -r '.target_directory')/ && \
                echo "BINARY_PATH=$BINARY_PATH" >> $GITHUB_ENV
            
            - name: Remove useless artifacts from previous build
              run: |
                find ${{ env.BINARY_PATH }} -mindepth 3 -maxdepth 3 -type d -exec rm -rf {} + && \
                rm -rf ${{ env.BINARY_PATH }}/release
      
            - name: Upload binary artifacts
              uses: actions/upload-artifact@v4
              with:
                name: "${{ matrix.app-name }}_binaries-${{ matrix.device }}"
                path: ${{env.BINARY_PATH}}
                if-no-files-found: error
          
